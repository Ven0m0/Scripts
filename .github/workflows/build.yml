name: Build and Release

on:
  push:
    tags: ["*"]

permissions:
  contents: write

jobs:
  build-release:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install AutoHotkey
        run: choco install autohotkey --version=2.0.19 -y
        shell: pwsh

      - name: Verify Installation
        run: |
          $compiler = "$env:ProgramFiles\AutoHotkey\Compiler\Ahk2Exe.exe"
          if (!(Test-Path $compiler)) { throw "Compiler not found: $compiler" }
          Write-Host "Compiler ready"
        shell: pwsh

      - name: Compile Scripts
        run: |
          $compiler = "$env:ProgramFiles\AutoHotkey\Compiler\Ahk2Exe.exe"
          $outDir = 'release'
          New-Item -Type Directory -Force $outDir | Out-Null

          $scripts = Get-ChildItem -Recurse -Filter *.ahk
          $compiled = 0
          $failed = @()

          $scripts | % {
            $outExe = Join-Path $outDir "$($_.BaseName).exe"
            $rel = $_.FullName -replace [regex]::Escape("$(Get-Location)\"), ''
            
            & $compiler /in $_.FullName /out $outExe 2>&1 | Out-Null
            
            if ($LASTEXITCODE -eq 0 -and (Test-Path $outExe)) {
              $compiled++
              $size = [math]::Round((Get-Item $outExe).Length / 1KB, 1)
              Write-Host "✓ $rel → $($_.BaseName).exe ($size KB)" -ForegroundColor Green
            } else {
              Write-Host "❌ $rel" -ForegroundColor Red
              $failed += $rel
            }
          }

          Write-Host "`nCompiled: $compiled/$($scripts.Count)"

          if ($failed) {
            Write-Host "`nFailed:" -ForegroundColor Red
            $failed | % { Write-Host "  $_" }
            exit 1
          }
        shell: pwsh

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*.exe
          fail_on_unmatched_files: true

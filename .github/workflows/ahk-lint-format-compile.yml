name: AHK Lint & Format

on:
  push:
    branches: [main, master]
    paths: ['**.ahk', '.github/workflows/ahk-lint-format-compile.yml']
  pull_request:
    branches: [main, master]
    paths: ['**.ahk', '.github/workflows/ahk-lint-format-compile.yml']
  workflow_dispatch:

permissions:
  contents: read

jobs:
  lint:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install AutoHotkey
        run: |
          $url = "https://www.autohotkey.com/download/ahk-install.exe"
          $inst = "$env:TEMP\ahk-install.exe"
          iwr -Uri $url -OutFile $inst
          Start-Process -FilePath $inst -ArgumentList "/S" -Wait
          if (!(Test-Path "C:\Program Files\AutoHotkey\AutoHotkey.exe")) { exit 1 }
        shell: pwsh

      - name: Syntax Check
        run: |
          $compiler = "C:\Program Files\AutoHotkey\Compiler\Ahk2Exe.exe"
          $tempDir = New-Item -ItemType Directory -Force -Path "$env:TEMP\ahk-check-$(Get-Random)"
          $errors = @()
          $checked = 0
          
          Get-ChildItem -Recurse -Filter "*.ahk" | ForEach-Object {
            $checked++
            $tempExe = Join-Path $tempDir "$([System.IO.Path]::GetRandomFileName()).exe"
            $rel = $_.FullName.Replace("$(Get-Location)\", "")
            
            & $compiler /in $_.FullName /out $tempExe 2>&1 | Out-Null
            if ($LASTEXITCODE -eq 0 -and (Test-Path $tempExe)) {
              Write-Host "✓ $rel" -ForegroundColor Green
              Remove-Item $tempExe -Force -ErrorAction SilentlyContinue
            } else {
              Write-Host "❌ $rel" -ForegroundColor Red
              $errors += $rel
            }
          }
          
          Remove-Item $tempDir -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "`nChecked: $checked | Failed: $($errors.Count)"
          if ($errors.Count -gt 0) { exit 1 }
        shell: pwsh

      - name: Format Check
        run: |
          $issues = @()
          
          Get-ChildItem -Recurse -Filter "*.ahk" | ForEach-Object {
            $content = Get-Content $_.FullName -Raw
            $rel = $_.FullName.Replace("$(Get-Location)\", "")
            $problems = @()
            
            if (($content -match "(?m)^\t") -and ($content -match "(?m)^    ")) {
              $problems += "mixed indentation"
            }
            if ($content -match "[ \t]+`r?`n") {
              $problems += "trailing whitespace"
            }
            if (($content -match "`r`n") -and ($content -match "(?<!`r)`n")) {
              $problems += "mixed line endings"
            }
            
            if ($problems.Count -gt 0) {
              Write-Host "⚠ $rel : $($problems -join ', ')" -ForegroundColor Yellow
              $issues += $rel
            }
          }
          
          if ($issues.Count -gt 0) {
            Write-Host "`n$($issues.Count) file(s) with format issues" -ForegroundColor Yellow
          } else {
            Write-Host "✓ All files formatted correctly" -ForegroundColor Green
          }
        shell: pwsh

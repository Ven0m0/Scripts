name: AHK Lint & Format

on:
  push:
    branches: [main, master]
    paths: ['**.ahk', '.github/workflows/ahk-lint-format-compile.yml']
  pull_request:
    branches: [main, master]
    paths: ['**.ahk', '.github/workflows/ahk-lint-format-compile.yml']
  workflow_dispatch:

permissions:
  contents: read

jobs:
  lint:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install AutoHotkey
        run: choco install autohotkey --version=2.0.19 -y
        shell: pwsh

      - name: Verify Installation
        run: |
          $ahk = "$env:ProgramFiles\AutoHotkey\v2\AutoHotkey64.exe"
          if (!(Test-Path $ahk)) { throw "Installation failed: $ahk not found" }
          Write-Host "Installed: $(& $ahk --version)"
        shell: pwsh

      - name: Syntax Check & Format Validation
        run: |
          $compiler = "$env:ProgramFiles\AutoHotkey\Compiler\Ahk2Exe.exe"
          $tempDir = New-Item -Type Directory -Force "$env:TEMP\ahk-$(Get-Random)"
          $syntaxErrors = @()
          $formatIssues = @()
          $checked = 0
          
          Get-ChildItem -Recurse -Filter *.ahk | % {
            $checked++
            $rel = $_.FullName -replace [regex]::Escape("$(Get-Location)\"), ''
            
            # Syntax check
            $tempExe = Join-Path $tempDir "$([IO.Path]::GetRandomFileName()).exe"
            & $compiler /in $_.FullName /out $tempExe 2>&1 | Out-Null
            
            if ($LASTEXITCODE -eq 0 -and (Test-Path $tempExe)) {
              Write-Host "✓ $rel" -ForegroundColor Green
              Remove-Item $tempExe -Force -EA SilentlyContinue
            } else {
              Write-Host "❌ $rel - syntax error" -ForegroundColor Red
              $syntaxErrors += $rel
            }
            
            # Format check
            $content = Get-Content $_.FullName -Raw
            $problems = @()
            if (($content -match '(?m)^\t') -and ($content -match '(?m)^    ')) { $problems += 'mixed indent' }
            if ($content -match '[ \t]+`r?`n') { $problems += 'trailing space' }
            if (($content -match '`r`n') -and ($content -match '(?<!`r)`n')) { $problems += 'mixed line endings' }
            
            if ($problems) {
              Write-Host "⚠ $rel : $($problems -join ', ')" -ForegroundColor Yellow
              $formatIssues += $rel
            }
          }
          
          Remove-Item $tempDir -Recurse -Force -EA SilentlyContinue
          
          Write-Host "`nChecked: $checked | Syntax errors: $($syntaxErrors.Count) | Format issues: $($formatIssues.Count)"
          
          if ($syntaxErrors) {
            Write-Host "`nSyntax errors in:" -ForegroundColor Red
            $syntaxErrors | % { Write-Host "  $_" }
            exit 1
          }
          
          if ($formatIssues) {
            Write-Host "`nFormat issues in:" -ForegroundColor Yellow
            $formatIssues | % { Write-Host "  $_" }
            exit 1
          }
        shell: pwsh
